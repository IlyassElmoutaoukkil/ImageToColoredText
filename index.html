<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>

    <div style="display: flex;height:100vh">
        <div style="width:25%;padding:20px;display:grid">
            <img src="image.png" id="image" alt="" style="height: auto;width:20%;margin-bottom:10px;margin:auto;">
            <input type="file" id="image_input" onchange="putImage()" style="margin: auto;">
            <div class="option_container">
                <label for="text">Text</label>
                <input name="text" id="text_area" name="" id="" cols="30" rows="10" value='&'>
            </div>
            <div class="option_container">
                <label for="letter_spacing">Line height</label>
                <input name="letter_spacing" type="range" value="0.4" min="0" max="15" step="0.1" id="letter_spacing_slider">
            </div>
            <div class="option_container">
                <label for="letter_size">Letter size</label>
                <input name="letter_size" type="range" value="22" min="2" max="30" id="letter_size_slider">
            </div>
            <div class="option_container">
                <label  for="line_height">Letter spacing</label>
                <input name="line_height" type="range" value="1" min="-10" max="10" id="line_height_slider">
            </div>
            <div class="option_container">
                <label  for="letter_weight">Letter Weight</label>
                <input name="letter_weight" type="range" value="500" min="100" max="900" id="letter_weight_slider">
            </div>
            <div id="smoothing_ratio_div" style="display: none;" class="option_container">
                <label  for="smoothing_ratio">smoothing ratio</label>
                <input name="smoothing_ratio" type="range" value="1" min="1" max="9" id="smoothing_ratio">
            </div>
            <div class="option_container">
                <label  for="ImageSmouthing">Image smouthing</label>
                <input  type="checkbox" name="ImageSmouthing" id="ImageSmouthing">
            </div>
            <div id="color_selection_container" style="display: block;">
                <label  for="backgroud_color">background color</label>
                <input  type="color" name="backgroud_color" id="backgroud_color">
            </div>
        </div>


    
        <div id="canvas_container" style="width:75%;display: flex;">
            <div id="disp" style="margin:auto;font-weight: 900;letter-spacing:-10px; font-size:20px;line-height: 7px;width:min-content;height:auto;border: 2px gray;" >
                
            </div>
            <canvas  id="canvas" style="height:100%;width:100%;display: none;">
            
            </canvas>
        </div>
        
    </div>
    
</body>

<script>
    // setting everthing up

    // read the image 

    // convert it to a matrix of RGB colors

    // get the text 

    // find how to give a litter a color;

    
 
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    var sizing_ratio = 1;
    var image_height = 60
    var image_width = 60
    var image_smoothing = false
    var background_color = '#ffffff'
    var extention = 'png'

    

    function showImage(src, target) {
        var fr = new FileReader();
        fr.onload = function (e) { target.src = this.result; draw() };
        fr.readAsDataURL(src.files[0]);      
    }

    function putImage() {
        var src = document.getElementById("image_input");
        var target = document.getElementById("image");

        // check extention 
        const filename_splited =  src.files[0].name.split('.');
        extention = filename_splited[filename_splited.length-1]

        // enable background color selection 
        if(extention == 'png'){
            document.getElementById('color_selection_container').style = 'block'
        }else{
            document.getElementById('color_selection_container').style = 'none'
        }

        console.log(extention)
        
        showImage(src, target);
    }



    function draw(){
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        var image = new Image();

        image.onload = function(){
            console.log('image loaded')

            number_length = String(image.width).length
            ratio = '0.';
            for (let r = 0; r < number_length.length; r++) {
                ratio = ratio+'0'
            }
            ratio = Number(ratio+sizing_ratio)
            console.log(image.width*ratio)
            document.getElementById("canvas").setAttribute('height',image.height+'px')
            document.getElementById("canvas").setAttribute('width',image.width+'px')

            if(!image_smoothing){
                ctx.msImageSmoothingEnabled = false;
                ctx.mozImageSmoothingEnabled = false;
                ctx.webkitImageSmoothingEnabled = false;
                ctx.imageSmoothingEnabled = false;
            }
            
            ctx.drawImage(
                image, 0, 0,    
                Math.floor(image.width*ratio), 
                Math.floor(image.height*ratio)
            );

            text = ''
            var text_value = document.getElementById("text_area").value;

            t=0
            
            for (let y = 0; y < Math.floor(image.height*ratio); y=y+2) {
                    for (let x = 0; x < Math.floor(image.width*ratio); x=x+2) {
                        t++
                        var c = ctx.getImageData(x, y, 2, 3).data;
                        if((text_value.length)>t){
                            if(text_value[t]==' '){
                                letter = '-'
                            }else{
                                var letter =  text_value[t]
                            }
                        }else{
                            var letter = text_value[0]
                            t=-1
                        }

                        if(extention=='png' && (c[0]=='0' && c[1]=='0' && c[2]=='0' && c[3]=='0')){
                            text = text+`<a style="color:${background_color}">${letter}</a>`
                        }else{
                            text = text+`<a style="color:rgb(${c[0]},${c[1]},${c[2]},${c[3]})">${letter}</a>`
                        }
                    }

                    text = text+' '
            }
            document.getElementById("disp").innerHTML=text;
        };


        image.src = document.getElementById('image').getAttribute('src');
        
    }

    window.onload = function(){
        draw()
    }
    
    document.getElementById("text_area").onchange = function(){
        draw()
    }


    text = ''


    var letter_spacing_value = document.getElementById("letter_spacing_slider");
    var letter_size_value = document.getElementById("letter_size_slider");
    var line_height_value = document.getElementById("line_height_slider");
    var letter_weight_value = document.getElementById("letter_weight_slider");
    var image_smouting = document.getElementById("ImageSmouthing");
    var smoothing_ratio = document.getElementById("smoothing_ratio");

    // Update the current slider value (each time you drag the slider handle)
    letter_spacing_value.oninput = function() {
        this.value;
        document.getElementById("disp").style.lineHeight = this.value+'px'
    }

    letter_size_value.oninput = function() {
        this.value;
        document.getElementById("disp").style.fontSize = this.value+'px'
    }

    line_height_value.oninput = function() {
        this.value;
        document.getElementById("disp").style.letterSpacing = this.value+'px'
    }

    letter_weight_value.oninput = function() {
        this.value;
        document.getElementById("disp").style.fontWeight = this.value
    }

    smoothing_ratio.oninput = function() {
        sizing_ratio = this.value;
        draw()
    }
    
    image_smouting.onchange = function() {
        image_smoothing = image_smouting.checked
        if(image_smoothing){
            document.getElementById("smoothing_ratio_div").style.display = 'block'
        }else{
            document.getElementById("smoothing_ratio_div").style.display = 'none'
            sizing_ratio = 1
        }
        draw()
    }

    backgroud_color.onchange = function() {
        background_color  = this.value
        draw()
    }

</script>

<style>
    label {
        width:50%;
        text-align: left;
    }

    .option_container{
        width:100%;
    }
</style>
</html>